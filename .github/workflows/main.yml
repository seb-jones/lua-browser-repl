name: CI

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      
      - name: Setup emsdk
        uses: mymindstorm/setup-emsdk@v11
        with:
          version: 2.0.34
          actions-cache-folder: 'emsdk-cache'

      - name: Cache Built Lua source code
        uses: actions/cache@v2
        with:
          key: ${{ runner.os }}-emscripten-lua-5.4.3
          path: ./code/libraries/lua-5.4.3

      - name: Fetch and build Lua source code
        run: make libraries

      - name: Build application in production mode
        run: make prod

      - uses: actions/setup-node@v2
        with:
          node-version: '14'
          cache: 'npm'

      - name: Unit test compiled Javascript
        run: |
          npm install
          npm test

      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          config: baseUrl=http://localhost
          start: npm start

      - name: Upload Cypress Screenshot Artifacts
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - name: Upload Cypress Video Artifacts
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Deploy built files to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
